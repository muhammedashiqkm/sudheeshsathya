{% extends "admin/base_admin.html" %}
{% load static %}

{% block admin_content %}
<div class="content-header">
    <h2>{{ title }}</h2>
    <a href="{% url 'admin_posts' %}" class="btn btn-outline">
        <i class="fas fa-arrow-left"></i> Back to Posts
    </a>
</div>

<div class="form-container">
    <form method="post" enctype="multipart/form-data" class="admin-form">
        {% csrf_token %}
        
        {# Main Post Form Fields #}
        <div class="form-group">
            <label for="{{ form.title.id_for_label }}">Title</label>
            {{ form.title }}
        </div>
        <div class="form-group">
            <label for="{{ form.excerpt.id_for_label }}">Excerpt</label>
            {{ form.excerpt }}
        </div>
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="{{ form.category.id_for_label }}">Category</label>
                {{ form.category }}
            </div>
            <div class="form-group col-md-6">
                <label for="{{ form.tags.id_for_label }}">Tags</label>
                {{ form.tags }}
            </div>
        </div>
        <div class="form-group">
            <label for="{{ form.image.id_for_label }}">Featured Image</label>
            {{ form.image }}
            {% if post and post.image %}
            <div class="current-image"><img src="{{ post.image.url }}" alt="Current image" style="max-width: 200px;"></div>
            {% endif %}
        </div>
        
        <hr>
        
        {# Content Blocks Section #}
        <div class="content-blocks-section">
            <h3>Content Blocks</h3>
            <div id="content-block-forms">
                {{ formset.management_form }}
                {% for form in formset.forms %}
                    <div class="content-block-form">
                        {{ form.id }}
                        <div class="form-row">
                            {# ADDED: Visible 'order' field #}
                            <div class="form-group col-md-2">
                                <label>Order</label>
                                {{ form.order }}
                            </div>
                            <div class="form-group col-md-4">
                                <label>Block Type</label>
                                {{ form.block_type }}
                            </div>
                            <div class="form-group col-md-6">
                                <label>Content</label>
                                {{ form.content }}
                            </div>
                        </div>
                         <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Image</label>
                                {{ form.image }}
                            </div>
                             <div class="form-group col-md-6">
                                <label>Caption</label>
                                {{ form.caption }}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">{{ form.DELETE }} Remove this block</label>
                        </div>
                        <hr>
                    </div>
                {% endfor %}
            </div>
            
            {# UPDATE: The hidden empty form for JavaScript cloning #}
            <div id="empty-form" style="display:none;">
                <div class="content-block-form">
                    {{ formset.empty_form.id }}
                    <div class="form-row">
                        {# ADDED: Visible 'order' field in empty form #}
                        <div class="form-group col-md-2">
                            <label>Order</label>
                            {{ formset.empty_form.order }}
                        </div>
                        <div class="form-group col-md-4"><label>Block Type</label>{{ formset.empty_form.block_type }}</div>
                        <div class="form-group col-md-6"><label>Content</label>{{ formset.empty_form.content }}</div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-6"><label>Image</label>{{ formset.empty_form.image }}</div>
                        <div class="form-group col-md-6"><label>Caption</label>{{ formset.empty_form.caption }}</div>
                    </div>
                    <div class="form-group"><label class="checkbox-label">{{ formset.empty_form.DELETE }} Remove this block</label></div>
                    <hr>
                </div>
            </div>
            <button type="button" id="add-block-btn" class="btn btn-outline">Add Content Block</button>
        </div>
        
        <hr>

        <div class="form-group">
            <label class="checkbox-label">{{ form.is_published }} Publish this post</label>
        </div>
        
        {# Subscriber Notification Section #}
        <div class="form-group">
            {% if post.notification_sent_at %}
                <p class="form-help-text">
                    <i class="fas fa-check-circle"></i> 
                    Notification sent to subscribers on {{ post.notification_sent_at|date:"F j, Y, P" }}.
                </p>
            {% else %}
                <label class="checkbox-label">{{ form.send_to_subscribers }} {{ form.send_to_subscribers.label }}</label>
                <p class="form-help-text">{{ form.send_to_subscribers.help_text }}</p>
            {% endif %}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Post</button>
            <a href="{% url 'admin_posts' %}" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</div>

{% block extra_scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize select2
    $('.select2').select2({ theme: 'classic', placeholder: 'Select tags...', allowClear: true });

    // Dynamic Formset for Content Blocks
    $('#add-block-btn').click(function() {
        var formsetContainer = $('#content-block-forms');
        var totalForms = $('#id_content_blocks-TOTAL_FORMS');
        var formIdx = parseInt(totalForms.val());
        
        // Clone the empty form
        var newForm = $('#empty-form .content-block-form').clone(true);
        
        // Update form prefixes
        newForm.html(newForm.html().replace(/__prefix__/g, formIdx));
        
        // Set the order
        newForm.find('input[name$="-order"]').val(formIdx);
        
        formsetContainer.append(newForm);
        totalForms.val(formIdx + 1);
    });
});
</script>
{% endblock %}
{% endblock %}